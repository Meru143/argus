name: Release

permissions:
  pull-requests: write
  contents: write

on:
  push:
    branches:
      - main

jobs:
  release-plz:
    name: Release-plz
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run release-plz
        uses: release-plz/action@v0.5
        id: release-plz
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      # Create PR for next release if changes exist
      - name: Create Release PR
        uses: release-plz/action@v0.5
        if: steps.release-plz.outputs.releases == '[]' || steps.release-plz.outputs.releases == '' 
        with:
          command: release-pr
        env:
          # Use GH_PAT if set to trigger CI workflows, otherwise fallback to GITHUB_TOKEN
          GITHUB_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      # Custom step: Sync version to NPM and Publish
      # Only runs if release-plz successfully released the main binary crate
      - name: Publish to NPM
        if: contains(steps.release-plz.outputs.releases, 'argus-ai')
        run: |
          echo "Release detected for argus-ai! Syncing to NPM..."
          
          # 1. Get version from Cargo.toml (it was just updated by release-plz)
          VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d '"' -f 2)
          echo "New version: $VERSION"
          
          # 2. Setup Node
          npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}
          
          # 3. Update package.json
          cd npm
          npm version $VERSION --no-git-tag-version --allow-same-version
          
          # 4. Publish
          npm publish --access public
